<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmConsilium</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.16/tailwind.min.css" rel="stylesheet">

  <!-- SEO Метатеги -->
  <title>Генератор маркетинговых идей | PharmConsilium</title>
  <meta name="description" content="Онлайн-чат от PharmConsilium помогает быстро получить креативные маркетинговые идеи для продвижения фармацевтического бизнеса.">
  <meta name="keywords" content="маркетинг, фармацевтика, идеи, чат, бизнес, PharmConsilium, генератор идей, продвижение">
  <meta name="author" content="PharmConsilium">

  <!-- Open Graph (для соцсетей) -->
  <meta property="og:title" content="Генератор маркетинговых идей | PharmConsilium">
  <meta property="og:description" content="Онлайн-чат для генерации креативных идей по продвижению фармацевтических услуг.">
  <meta property="og:image" content="/favicon.ico">
  <meta property="og:url" content="https://pharmconsilium.com/">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Генератор маркетинговых идей | PharmConsilium">
  <meta name="twitter:description" content="PharmConsilium помогает фармацевтам и бизнесу находить уникальные идеи для продвижения.">
  <meta name="twitter:image" content="/favicon.ico">

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(45, 55, 72, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(45, 55, 72, 0); }
      100% { box-shadow: 0 0 0 0 rgba(45, 55, 72, 0); }
    }

    .typing-dots span {
      display: inline-block;
      opacity: 0;
      animation: typing 1.5s infinite;
    }
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.5s; }
    .typing-dots span:nth-child(3) { animation-delay: 1s; }
    @keyframes typing {
      0%, 100% { opacity: 0; }
      50%      { opacity: 1; }
    }

    .hidden { display: none; }
    .bg-custom-gray { background-color: #2D3748; }

    #chat-widget-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      z-index: 9999;
    }

    /* Вариант 1: при collapsed — весь контейнер не ловит клики, кроме самой иконки */
    #chat-widget-container.collapsed {
      pointer-events: none;
    }
    #chat-widget-container.collapsed #chat-bubble {
      pointer-events: auto;
    }

    #chat-popup {
      position: fixed;
      bottom: 20px;
      right: 5%;
      width: 400px;
      height: 600px;
      border: none;
      z-index: 3;
    }

    #chat-bubble {
      position: fixed;
      width: 50px;
      height: 50px;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      background-color: #2D3748;
      animation: pulse 2s infinite;
    }

    .reply-avatar-container { display: flex; align-items: center; }
    .reply-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }

    @media (max-width: 768px) {
      #chat-popup {
        top: 0; right: 0; bottom: 0; left: 0;
        width: 97%; height: 88%;
        margin-top: 20%; margin-left: 1%;
        border-radius: 0; overflow: hidden;
        z-index: 9999;
      }
    }

    .disabled-input {
      background-color: #f0f0f0;
      color: #a0a0a0;
      cursor: not-allowed;
    }
    .disabled-button {
      background-color: #d0d0d0;
      color: #a0a0a0;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="chat-widget-container">
    <div id="chat-bubble" class="w-16 h-16 rounded-full flex items-center justify-center cursor-pointer text-3xl">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
      </svg>
    </div>

    <div id="chat-popup" class="hidden absolute bottom-20 right-0 w-96 bg-white rounded-md shadow-md flex flex-col transition-all text-sm">
      <div id="chat-header" class="flex justify-between items-center p-4 bg-custom-gray text-white rounded-t-md">
        <h3 class="m-0 text-lg">Генератор маркетинговых идей</h3>
        <button id="close-popup" class="bg-transparent border-none text-white cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="chat-messages" class="flex-1 p-4 overflow-y-auto"></div>
      <div id="chat-input-container" class="p-4 border-t border-gray-200">
        <div class="flex space-x-4 items-center">
          <input type="text" id="chat-input" class="flex-1 border border-gray-300 rounded-md px-4 py-2 outline-none w-3/4" placeholder="Задайте вопрос">
          <button id="chat-submit" class="bg-custom-gray text-white rounded-md px-4 py-2 cursor-pointer">Отправить</button>
        </div>
        <div class="flex text-center text-xs pt-4">
          <span class="flex-1">PharmConsilium</span>
        </div>
      </div>
    </div>

    <iframe id="chat-widget-iframe" style="display: none;" src="about:blank"></iframe>
  </div>

  <script>
    let isWidgetOpenedManually = false;
    let isUserMessageSent = false;
    let currentSessionId = null;

    document.addEventListener('DOMContentLoaded', function () {
      const chatInput     = document.getElementById('chat-input');
      const chatSubmit    = document.getElementById('chat-submit');
      const chatMessages  = document.getElementById('chat-messages');
      const chatBubble    = document.getElementById('chat-bubble');
      const chatPopup     = document.getElementById('chat-popup');
      const closePopupBtn = document.getElementById('close-popup');

      chatSubmit.addEventListener('click', onSubmit);
      chatInput.addEventListener('keyup', e => { if (e.key === 'Enter') onSubmit(); });

      chatBubble.addEventListener('click', () => { togglePopup(); isWidgetOpenedManually = true; });
      chatBubble.addEventListener('touchstart', () => { togglePopup(); isWidgetOpenedManually = true; });
      closePopupBtn.addEventListener('click', togglePopup);

      // Приветственное сообщение сразу
      reply('Привет! Я Искуственный Интеллект, работающий на алгоритмах GPT-4. Выполняю функции генератора маркетинговых идей. Напишите мне подробно Ваше задание, я попытаюсь предложить Вам несколько полезных идей. Чем больше подробностей будет в Вашем задании, тем более подробный ответ Вы получите.', false);
    });

    function onSubmit() {
      if (isUserMessageSent) return;
      const inp = document.getElementById('chat-input');
      const msg = inp.value.trim();
      if (!msg) return;

      appendUserMessage(msg);
      inp.value = '';
      lockInput();

      onUserRequest(msg);
      isUserMessageSent = true;
    }

    function lockInput() {
      const inp = document.getElementById('chat-input');
      const btn = document.getElementById('chat-submit');
      inp.disabled = true; inp.classList.add('disabled-input');
      btn.disabled = true; btn.classList.add('disabled-button');
    }

    function togglePopup() {
      const container = document.getElementById('chat-widget-container');
      const popup     = document.getElementById('chat-popup');
      popup.classList.toggle('hidden');
      container.classList.toggle('collapsed');
    }

    function appendUserMessage(text) {
      const chatMessages = document.getElementById('chat-messages');
      const el = document.createElement('div');
      el.className = 'flex justify-end mb-3';
      el.innerHTML = `<div class="bg-gray-800 text-white rounded-lg py-2 px-4 max-w-[70%]">${text}</div>`;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
      const chatMessages = document.getElementById('chat-messages');
      const ind = document.createElement('div');
      ind.className = 'reply-avatar-container mb-3';
      ind.innerHTML = `
        <img src="images/robo.png" alt="Avatar" class="reply-avatar mr-2">
        <div class="bg-gray-200 text-black rounded-lg py-2 px-4 max-w-[70%]">
          Печатает<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>`;
      chatMessages.appendChild(ind);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
      const chatMessages = document.getElementById('chat-messages');
      const ind = chatMessages.querySelector('.reply-avatar-container');
      if (ind) chatMessages.removeChild(ind);
    }

    function onUserRequest(userMessage) {
      showTypingIndicator();
      axios.post('https://HappyDoomGuy.pythonanywhere.com/api/chat', { message: userMessage })
        .then(res => {
          const replyText = res.data.reply || 'Извините, я не могу ответить на это.';
          currentSessionId = res.data.session_id;
          reply(replyText, false);
          addFeedbackButtons();
        })
        .catch(err => {
          hideTypingIndicator();
          reply('Извините, произошла ошибка: ' + err.message, false);
        });
    }

    function reply(message, isUser, isEmailInput = false) {
      hideTypingIndicator();
      const chatMessages = document.getElementById('chat-messages');
      const wrapper = document.createElement('div');
      wrapper.className = `flex mb-3 ${isUser ? 'justify-end' : 'items-center'}`;

      let html;
      if (isEmailInput) {
        html = `
          <div class="flex flex-col ${isUser ? 'bg-gray-800 text-white' : 'bg-gray-200 text-black'} rounded-lg py-2 px-4 max-w-[70%]">
            ${message}
            <input type="email" class="email-input mt-2 px-2 py-1 rounded" placeholder="Ваша электронная почта">
            <button class="email-submit-btn mt-2 bg-gray-500 text-white rounded px-2 py-1">Отправить</button>
          </div>`;
      } else {
        html = `<div class="${isUser ? 'bg-gray-800 text-white' : 'bg-gray-200 text-black'} rounded-lg py-2 px-4 max-w-[70%]">${message}</div>`;
      }

      wrapper.innerHTML = (isUser ? html : `<img src="images/robo.png" alt="Avatar" class="reply-avatar mr-2">${html}`);
      chatMessages.appendChild(wrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (isEmailInput) setupEmailInput(wrapper);
    }

    function setupEmailInput(wrapper) {
      const input = wrapper.querySelector('.email-input');
      const btn   = wrapper.querySelector('.email-submit-btn');
      input.addEventListener('keypress', e => { if (e.key === 'Enter') btn.click(); });
      btn.addEventListener('click', () => {
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value)) {
          sendEmail(input.value);
          btn.disabled = true;
          wrapper.innerHTML = '';
          reply('Спасибо, мы свяжемся с Вами в ближайшее время.', false);
        } else {
          alert('Пожалуйста, введите действительный адрес электронной почты.');
        }
      });
    }

    function sendEmail(email) {
      axios.post('https://HappyDoomGuy.pythonanywhere.com/api/email', {
        session_id: currentSessionId,
        email: email
      })
      .then(() => console.log("Email отправлен успешно"))
      .catch(err => {
        console.error("Ошибка при отправке email:", err);
        alert('Произошла ошибка при отправке электронной почты. Пожалуйста, попробуйте снова.');
      });
    }

    function addFeedbackButtons() {
      const chatMessages = document.getElementById('chat-messages');
      const fb = document.createElement('div');
      fb.className = 'flex justify-center items-center my-3';
      fb.innerHTML = `
        <div class="text-center mr-4">Полезно ли было?</div>
        <button class="feedback-yes bg-green-500 text-white rounded-md px-4 py-2 mr-2">Да</button>
        <button class="feedback-no bg-red-500 text-white rounded-md px-4 py-2">Нет</button>`;
      chatMessages.appendChild(fb);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      fb.querySelector('.feedback-yes').addEventListener('click', () => sendFeedback(fb, true));
      fb.querySelector('.feedback-no').addEventListener('click', () => sendFeedback(fb, false));
    }

    function sendFeedback(container, positive) {
      axios.post('https://HappyDoomGuy.pythonanywhere.com/api/feedback', {
        session_id: currentSessionId,
        feedback: positive ? 'Да' : 'Нет'
      }).catch(err => console.error("Ошибка при отправке отзыва:", err));

      if (positive) {
        reply('Если хотите еще больше идей, поделитесь пожалуйста Вашей электронной почтой. Мы обязательно Вам напишем.', false, true);
      } else {
        reply('Спасибо за Ваш отзыв', false);
      }
      container.remove();
    }
  </script>
</body>
</html>
